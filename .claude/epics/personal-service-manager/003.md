---
name: 數據庫設計和模式實現
status: open
created: 2025-09-13T00:00:00Z
updated: 2025-09-13T00:00:00Z
github: [Will be updated when synced to GitHub]
depends_on: ["001"]
parallel: true
conflicts_with: []
---

# Task: 數據庫設計和模式實現

## Description
設計並實現Personal Service Manager的數據庫模式，創建Supabase數據庫表結構，實現完整的數據模型包括Service、MonitoringLog、NotificationLog等核心實體，建立數據完整性約束和索引優化。

## Acceptance Criteria
- [ ] 設計完整的數據庫模式，包括Service、MonitoringLog、NotificationLog等核心表
- [ ] 創建Supabase數據庫表結構和關系定義
- [ ] 實現數據完整性約束、外鍵約束和唯一性約束
- [ ] 建立數據索引優化查詢性能
- [ ] 創建數據庫migration腳本和版本控制
- [ ] 實現基礎的數據庫查詢和操作接口
- [ ] 建立數據備份和恢復策略
- [ ] 創建數據庫文檔和ER圖表

## Technical Details
- **Implementation approach**:
  - 使用Supabase PostgreSQL作為主數據庫
  - 基於epic中定義的數據模型接口實現數據庫表結構
  - 使用Supabase Schema Designer或原生SQL創建表結構
  - 實現適當的索引策略以優化查詢性能
  - 創建數據庫觸發器和約束來確保數據完整性

- **Key considerations**:
  - 確保數據庫設計支持實時監控和即時通知功能
  - 考慮數據增長和查詢性能優化
  - 設置適當的數據類型和約束以確保數據完整性
  - 實現數據分片和歸檔策略以應對長期存儲需求
  - 配置數據庫權限和訪問控制

- **Code locations/files affected**:
  - 數據庫schema: `supabase/migrations/` 目錄下的migration文件
  - 數據庫類型定義: `backend/src/types/database.ts` 或 `shared/src/database/types.ts`
  - 數據庫配置: `supabase/config.ts` 或相應的配置文件
  - 數據庫工具腳本: `scripts/database/` 目錄
  - 數據庫文檔: `docs/database/` 目錄

### 數據表結構設計

#### services 表（服務配置）
```sql
CREATE TABLE services (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  type VARCHAR(50) NOT NULL CHECK (type IN ('http', 'tcp', 'script', 'process')),
  endpoint TEXT NOT NULL,
  monitoring_config JSONB NOT NULL DEFAULT '{"interval": 5, "timeout": 30, "retries": 3}',
  notification_config JSONB NOT NULL DEFAULT '{"enabled": false}',
  status VARCHAR(20) NOT NULL DEFAULT 'stopped' CHECK (status IN ('running', 'stopped', 'error')),
  last_check TIMESTAMPTZ,
  tags TEXT[] DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### monitoring_logs 表（監控記錄）
```sql
CREATE TABLE monitoring_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  service_id UUID NOT NULL REFERENCES services(id) ON DELETE CASCADE,
  timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  status VARCHAR(20) NOT NULL CHECK (status IN ('success', 'failed', 'timeout')),
  response_time INTEGER NOT NULL,
  error_message TEXT,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### notification_logs 表（通知記錄）
```sql
CREATE TABLE notification_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  service_id UUID NOT NULL REFERENCES services(id) ON DELETE CASCADE,
  type VARCHAR(20) NOT NULL CHECK (type IN ('ntfy', 'webhook')),
  timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  status VARCHAR(20) NOT NULL CHECK (status IN ('sent', 'failed')),
  message TEXT NOT NULL,
  error TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 索引和約束
```sql
-- services表索引
CREATE INDEX idx_services_status ON services(status);
CREATE INDEX idx_services_type ON services(type);
CREATE INDEX idx_services_tags ON services USING GIN(tags);

-- monitoring_logs表索引
CREATE INDEX idx_monitoring_logs_service_id ON monitoring_logs(service_id);
CREATE INDEX idx_monitoring_logs_timestamp ON monitoring_logs(timestamp);
CREATE INDEX idx_monitoring_logs_status ON monitoring_logs(status);
CREATE INDEX idx_monitoring_logs_service_timestamp ON monitoring_logs(service_id, timestamp);

-- notification_logs表索引
CREATE INDEX idx_notification_logs_service_id ON notification_logs(service_id);
CREATE INDEX idx_notification_logs_timestamp ON notification_logs(timestamp);
CREATE INDEX idx_notification_logs_status ON notification_logs(status);
CREATE INDEX idx_notification_logs_type ON notification_logs(type);
```

## Dependencies
- [ ] Task 001: 項目初始化和基礎設施設置（Supabase帳號和數據庫實例）
- [ ] 外部依賴：Supabase PostgreSQL數據庫服務

## Effort Estimate
- Size: L (Large)
- Hours: 24 hours (3 days)
- Parallel: true

## Definition of Done
- [ ] 完整的數據庫模式設計文檔完成
- [ ] 所有核心表結構在Supabase中創建完成
- [ ] 數據完整性約束和外鍵關系實現完成
- [ ] 性能優化索引創建完成
- [ ] 數據庫migration腳本和版本控制建立完成
- [ ] 基礎數據庫查詢接口實現完成
- [ ] 數據庫文檔和ER圖表完成
- [ ] 數據庫性能測試通過
- [ ] 數據庫權限和安全配置完成