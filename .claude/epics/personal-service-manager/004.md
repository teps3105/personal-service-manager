---
name: RESTful API 架構設計
status: open
created: 2025-09-13T00:00:00Z
updated: 2025-09-13T00:00:00Z
github: [Will be updated when synced to GitHub]
depends_on: ["001", "003"]
parallel: true
conflicts_with: []
---

# Task: RESTful API 架構設計

## Description
設計並實現Personal Service Manager的RESTful API架構，創建完整的API端點結構，集成Prisma ORM進行數據庫操作，實現服務管理、監控、通知和報告等核心功能的API接口，建立API文檔和測試框架。

## Acceptance Criteria
- [ ] 設計完整的RESTful API端點結構和路由架構
- [ ] 實現所有核心服務管理API端點（CRUD操作）
- [ ] 實現監控相關API端點（狀態檢查、歷史查詢）
- [ ] 實現通知系統API端點（測試、日誌查詢）
- [ ] 實現報告和統計API端點
- [ ] 集成Prisma ORM與Supabase數據庫連接
- [ ] 實現API認證和授權機制
- [ ] 建立API文檔（Swagger/OpenAPI）和測試框架
- [ ] 實現API錯誤處理和響應格式標準化

## Technical Details
- **Implementation approach**:
  - 使用Express.js作為Web框架，結合TypeScript進行類型安全開發
  - 集成Prisma ORM進行數據庫操作和查詢
  - 基於epic中定義的API端點架構實現具體路由
  - 使用Swagger/OpenAPI生成API文檔
  - 實現JWT認證和基於角色的訪問控制
  - 使用Jest或Mocha進行API測試

- **Key considerations**:
  - 確保API設計符合RESTful原則和最佳實踐
  - 實現適當的錯誤處理和HTTP狀態碼使用
  - 建立統一的API響應格式和數據驗證
  - 考慮API性能優化和緩存策略
  - 實現適當的日誌記錄和監控機制

- **Code locations/files affected**:
  - API路由: `backend/src/routes/` 目錄下的路由文件
  - API控制器: `backend/src/controllers/` 目錄下的控制器文件
  - API中間件: `backend/src/middleware/` 目錄下的中間件文件
  - Prisma配置: `backend/prisma/` 目錄，包括`schema.prisma`和migration
  - API文檔: `backend/docs/` 或 `backend/swagger.json`
  - 測試文件: `backend/src/tests/` 或 `backend/__tests__/` 目錄

### API端點設計

#### 核心服務 API
```typescript
// GET /api/services - 獲取服務列表
interface GetServicesResponse {
  services: Service[];
  pagination: {
    page: number;
    limit: number;
    total: number;
  };
}

// POST /api/services - 創建新服務
interface CreateServiceRequest {
  name: string;
  type: 'http' | 'tcp' | 'script' | 'process';
  endpoint: string;
  monitoringConfig: {
    interval: number;
    timeout: number;
    retries: number;
  };
  notificationConfig: {
    ntfyTopic?: string;
    webhookUrl?: string;
    enabled: boolean;
  };
  tags: string[];
}

// PUT /api/services/:id - 更新服務配置
interface UpdateServiceRequest extends Partial<CreateServiceRequest> {}

// DELETE /api/services/:id - 刪除服務
// POST /api/services/:id/start - 啟動服務
// POST /api/services/:id/stop - 停止服務
// POST /api/services/:id/restart - 重啟服務
```

#### 監控 API
```typescript
// GET /api/monitoring/status - 獲取監控狀態
interface GetMonitoringStatusResponse {
  services: {
    id: string;
    name: string;
    status: 'running' | 'stopped' | 'error';
    lastCheck: Date;
    responseTime?: number;
  }[];
  system: {
    totalServices: number;
    onlineServices: number;
    offlineServices: number;
    lastCheckTime: Date;
  };
}

// POST /api/monitoring/checks - 執行監控檢查
interface ExecuteMonitoringChecksRequest {
  serviceIds?: string[]; // 空陣列表示檢查所有服務
}

// GET /api/monitoring/history - 獲取監控歷史
interface GetMonitoringHistoryRequest {
  serviceId?: string;
  status?: 'success' | 'failed' | 'timeout';
  startTime?: Date;
  endTime?: Date;
  page?: number;
  limit?: number;
}

interface GetMonitoringHistoryResponse {
  logs: MonitoringLog[];
  pagination: {
    page: number;
    limit: number;
    total: number;
  };
}
```

#### 通知 API
```typescript
// POST /api/notifications/test - 測試通知
interface TestNotificationRequest {
  type: 'ntfy' | 'webhook';
  config: {
    ntfyTopic?: string;
    webhookUrl?: string;
  };
  message: string;
}

// GET /api/notifications/logs - 獲取通知歷史
interface GetNotificationLogsRequest {
  serviceId?: string;
  type?: 'ntfy' | 'webhook';
  status?: 'sent' | 'failed';
  startTime?: Date;
  endTime?: Date;
  page?: number;
  limit?: number;
}

interface GetNotificationLogsResponse {
  logs: NotificationLog[];
  pagination: {
    page: number;
    limit: number;
    total: number;
  };
}
```

#### 報告 API
```typescript
// GET /api/reports/services - 服務報告
interface GetServiceReportsRequest {
  timeRange: '24h' | '7d' | '30d' | '90d';
  format?: 'json' | 'csv';
}

// GET /api/reports/system - 系統報告
interface GetSystemReportsRequest {
  timeRange: '24h' | '7d' | '30d' | '90d';
  includeMetrics?: boolean;
}

// POST /api/reports/export - 導出報告
interface ExportReportRequest {
  reportType: 'services' | 'system' | 'monitoring' | 'notifications';
  format: 'json' | 'csv' | 'pdf';
  filters: Record<string, any>;
}
```

### Prisma Schema 設計
```prisma
// backend/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Service {
  id                 String   @id @default(uuid())
  name               String   @db.VarChar(255)
  type               String   @db.VarChar(50)
  endpoint           String   @db.Text
  monitoringConfig   Json
  notificationConfig Json
  status             String   @db.VarChar(20) @default("stopped")
  lastCheck          DateTime?
  tags               String[]
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  monitoringLogs    MonitoringLog[]
  notificationLogs NotificationLog[]

  @@map("services")
}

model MonitoringLog {
  id           String   @id @default(uuid())
  serviceId    String
  timestamp    DateTime @default(now())
  status       String   @db.VarChar(20)
  responseTime Int
  errorMessage String?
  metadata     Json
  createdAt    DateTime @default(now())

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("monitoring_logs")
}

model NotificationLog {
  id        String   @id @default(uuid())
  serviceId String
  type      String   @db.VarChar(20)
  timestamp DateTime @default(now())
  status    String   @db.VarChar(20)
  message   String   @db.Text
  error     String?
  createdAt DateTime @default(now())

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("notification_logs")
}
```

## Dependencies
- [ ] Task 001: 項目初始化和基礎設施設置（後端項目結構）
- [ ] Task 003: 數據庫設計和模式實現（數據庫表結構和約束）
- [ ] 外部依賴：Node.js + Express.js、Prisma ORM、Supabase PostgreSQL

## Effort Estimate
- Size: L (Large)
- Hours: 32 hours (4 days)
- Parallel: true

## Definition of Done
- [ ] 完整的RESTful API端點結構設計完成
- [ ] 所有核心API端點實現完成並通過測試
- [ ] Prisma ORM集成完成，數據庫操作正常
- [ ] API認證和授權機制實現完成
- [ ] API文檔（Swagger/OpenAPI）生成完成
- [ ] API測試框架和測試用例完成
- [ ] API錯誤處理和響應格式標準化完成
- [ ] API性能測試通過
- [ ] API文檔和開發者指南完成